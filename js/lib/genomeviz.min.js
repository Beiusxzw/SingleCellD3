!function(global,factory){"object"==typeof exports&&"undefined"!=typeof module?factory(exports):"function"==typeof define&&define.amd?define(["exports"],factory):factory((global="undefined"!=typeof globalThis?globalThis:global||self).genomeviz=global.genomeviz||{})}(this,(function(exports){"use strict";var version="1.0.0";function clearGenomeViz(target){$(target).empty()}function createGenomeViz(target,chrom,genemin,genemax,data){var margin_top=20,margin_bottom=20,margin_left=0,margin_right=15,width=1e3-margin_left-margin_right;const height=100-margin_top-margin_bottom;var xScale=d3.scaleLinear().domain([genemin,genemax]).range([0,width]),yScale=d3.scaleLinear().domain([0,100]).range([0,height]),xAxis=d3.axisBottom(xScale).ticks(10),xAxisGrid=d3.axisBottom(xScale).ticks(10).tickSize(-height,0,0).tickFormat(""),sExtM=width/Math.abs(xScale(100)-xScale(1)),brush=d3.brushX().extent([[0,0],[width,height]]).on("end",updateChart),svg=d3.select(target).append("svg").attr("width",width+margin_left+margin_right).attr("height",height+margin_top+margin_bottom).append("g").attr("transform","translate("+margin_left+","+margin_top+")").attr("viewBox",[width,1.2*height,width,2*height]);svg.append("g").attr("class","brush").call(brush);var gX=svg.append("g").attr("class","x axis").attr("transform","translate(0, "+height+")").call(xAxis);function getY(d){return"exon"==d.feature?20:"gene"==d.feature?20:"transcript"==d.feature?20:"CDS"==d.feature?20:"stop_codon"==d.feature?20:"three_prime_utr"==d.feature?20:"te"==d.feature?40:"grna"==d.feature?10:void 0}function getHeight(d){return"grna"==d.feature?5:"CDS"==d.feature?15:"stop_codon"==d.feature?15:(d.feature,10)}function getColor(d){return"exon"==d.feature?"#0E0080":"gene"==d.feature?"#0E0080":"CDS"==d.feature?"#0E0080":"transcript"==d.feature?"#0E0080":"stop_codon"==d.feature?"#000":"three_prime_utr"==d.feature?"#000":"te"==d.feature?"#479AB3":"grna"==d.feature?"red":void 0}svg.selectAll("gene").data(data).enter().append("rect").attr("class","gtf-rect").attr("x",d=>xScale(d.start)).attr("y",d=>yScale(getY(d))).attr("width",d=>xScale(d.end)-xScale(d.start)).attr("height",d=>getHeight(d)).attr("fill",d=>getColor(d)).attr("title",d=>d.feature).on("mouseover",(function(d,i){d3.select(this).transition().duration("100").attr("fill","#3598DB")})).on("mouseout",(function(d,i){d3.select(this).transition().duration("100").attr("fill",d=>getColor(d))})),svg.selectAll("name").data(data).enter().append("text").attr("class","gtf-text").attr("x",d=>xScale(d.start)+(xScale(d.end)-xScale(d.start))/2).attr("y",d=>yScale(getY(d)-5)).attr("font-size","6pt").text(d=>d.name);var data_forward=Array();data.map((function(d){"+"==d.strand&&data_forward.push(d)}));var data_reverse=Array(),idleTimeout;function idled(){idleTimeout=null}function updateChart(event){if(extent=event.selection,extent)xScale.domain([xScale.invert(extent[0]),xScale.invert(extent[1])]),svg.selectAll("gene").select(".brush").call(brush.move,null);else{if(!idleTimeout)return idleTimeout=setTimeout(idled,350);xScale.domain([genemin,genemax])}gX.transition().duration(1e3).call(d3.axisBottom(xScale)),svg.selectAll(".gtf-rect").transition().duration(1e3).attr("x",d=>xScale(d.start)).attr("width",(function(d){return xScale(d.end)-xScale(d.start)})),svg.selectAll(".forward").transition().duration(1e3).attr("transform",(function(d){return"translate("+xScale(d.end)+","+yScale(getY(d))+")"})),svg.selectAll(".reverse").transition().duration(1e3).attr("transform",(function(d){return"translate("+xScale(d.start)+","+yScale(getY(d))+")"})),svg.selectAll(".gtf-text").transition().duration(1e3).attr("x",d=>xScale(d.start)+(xScale(d.end)-xScale(d.start))/2).attr("y",d=>yScale(getY(d)-5))}data.map((function(d){"-"==d.strand&&data_reverse.push(d)})),svg.selectAll("marker").data(data_forward).enter().append("g").attr("class","forward").attr("transform",(function(d){return"translate("+xScale(d.end)+","+yScale(getY(d))+")"})).append("path").attr("id","forward_arrow").attr("x0",d=>xScale(d.end)).attr("y0",d=>yScale(getY(d))).attr("d",d=>"M 0,0 V"+getHeight(d)+"L"+getHeight(d)/2+","+getHeight(d)/2+" Z"),svg.selectAll("marker").data(data_reverse).enter().append("g").attr("class","reverse").attr("transform",(function(d){return"translate("+xScale(d.start)+","+yScale(getY(d))+")"})).append("path").attr("id","forward_arrow").attr("x0",d=>xScale(d.start)).attr("y0",d=>yScale(getY(d))).attr("d",d=>"M 0,0 V"+getHeight(d)+"L"+-getHeight(d)/2+","+getHeight(d)/2+"Z ");var legend=svg.append("g");legend.append("rect").attr("x",8).attr("y",0).attr("width",100).attr("height",55).attr("stroke","black").attr("stroke-width",.5).attr("fill","white").style("z-index",1e5),legend.append("text").text("5' =>  3'").attr("x",40).attr("y",13).attr("font-family","arial").attr("font-size","11px").attr("fill","black").attr("z-index",1e5),legend.append("line").attr("x1",15).attr("x2",45).attr("y1",22).attr("y2",22).attr("stroke-width",10).attr("stroke","#479AB3").attr("z-index",1e5),legend.append("text").text("TE").attr("x",50).attr("y",25).attr("font-family","arial").attr("font-size","10px").attr("fill","black").attr("z-index",1e5),legend.append("line").attr("x1",15).attr("x2",45).attr("y1",34.5).attr("y2",34.5).attr("stroke-width",10).attr("stroke","#0E0080").attr("z-index",1e5),legend.append("text").text("Genes").attr("x",50).attr("y",37.5).attr("font-family","arial").attr("font-size","10px").attr("fill","black").attr("z-index",1e5),legend.append("line").attr("x1",15).attr("x2",45).attr("y1",47).attr("y2",47).attr("stroke-width",8).attr("stroke","red").attr("z-index",1e5),legend.append("text").text("gRNA").attr("x",50).attr("y",50).attr("font-family","arial").attr("font-size","10px").attr("fill","black").attr("z-index",1e5),legend.append("text").text("chromosome"+chrom).attr("x",width/2).attr("y",0).attr("font-family","arial").attr("font-size","12px").attr("font-weight",600).attr("fill","black").attr("z-index",1e5),legend.append("text").text("Select to zoom. Double-click to recover").attr("x",width-200).attr("y",height-10).attr("font-family","arial").attr("font-size","8px").attr("fill","black").attr("z-index",1e5)}function createPie(target,color,data){var total=Object.values(data).reduce((a,b)=>a+b,0).toString(),data=Object.entries(data).map(d=>({name:d[0],value:d[1]})),color=color.range(d3.quantize(t=>d3.interpolateSpectral(.8*t+.1),data.length).reverse()),arc=d3.arc().innerRadius(10).outerRadius(Math.min(width,height)/2-1);const radius=Math.min(width,height)/2*.8;var arcLabel=d3.arc().innerRadius(radius).outerRadius(radius),pie;const arcs=d3.pie().sort(null).value(d=>d.value)(data),svg=d3.select(target).append("svg").attr("viewBox",[-width/2,-height/2,width,height]);svg.append("g").attr("stroke","white").attr("stroke-width",".2pt").selectAll("path").data(arcs).join("path").attr("fill",d=>color(d.data.name)).attr("d",arc).transition().duration(2e3);var mm_tooltip=createTooltip(target),sum=Object.values(data).map(d=>d.value).reduce((a,b)=>a+b,0);svg.selectAll("path").on("mouseover",(function(d,i){d3.select(this).transition().duration("100").attr("stroke-width",".1pt"),mm_tooltip.transition().duration(200).style("opacity",1),mm_tooltip.html(`${i.data.name}: ${i.data.value.toLocaleString()}`+" ("+(100*i.data.value/sum).toFixed(2)+"%)")})),svg.selectAll("path").on("mouseout",(function(d,i){d3.select(this).transition().duration("100").attr("stroke-width",".2pt"),mm_tooltip.transition().duration(200).style("opacity",0)})),svg.append("g").attr("font-family","sans-serif").attr("font-size",0).attr("text-anchor","middle").selectAll("text").data(arcs).join("text").attr("transform",d=>`translate(${arcLabel.centroid(d)})`).call(text=>text.append("tspan").attr("y","-0.4em").attr("font-weight","bold").text(d=>d.data.name)).call(text=>text.filter(d=>d.endAngle-d.startAngle>.25).append("tspan").attr("x",0).attr("y","0.7em").attr("fill-opacity",.7).text(d=>d.data.value.toLocaleString())),svg.append("text").attr("x",-8).attr("y",0).text("Total = "+total).attr("fill","black").style("font-size","2pt").style("font-weight",900)}function createTooltip(target){var tooltip;return d3.select(target).append("div").attr("class","hov-tooltip").style("opacity",0).style("z-index","1000")}exports.clearGenomeViz=clearGenomeViz,exports.createGenomeViz=createGenomeViz,exports.createTooltip=createTooltip,exports.createPie=createPie}));